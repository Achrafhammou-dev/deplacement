<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Operations Intelligence | Advanced Analytics</title>
    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/9322/9322127.png">

    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --primary-glow: radial-gradient(circle at 50% -20%, #4f46e5 0%, rgba(0,0,0,0) 50%);
            --glass-bg: rgba(15, 23, 42, 0.75);
            --glass-border: rgba(255, 255, 255, 0.08);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #020617;
            background-image: var(--primary-glow);
            background-attachment: fixed;
            color: #e2e8f0;
            overflow-x: hidden;
        }

        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .glass-panel:hover {
            border-color: rgba(255, 255, 255, 0.15);
            transform: translateY(-2px);
            box-shadow: 0 15px 40px rgba(79, 70, 229, 0.15);
        }

        /* Loading Bar */
        .loader-bar { height: 3px; width: 100%; position: fixed; top: 0; left: 0; z-index: 50; }
        .loader-progress { height: 100%; background: #6366f1; width: 0%; transition: width 0.5s ease; }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
        
        .animate-in { animation: fadeIn 0.6s ease-out forwards; opacity: 0; transform: translateY(10px); }
        @keyframes fadeIn { to { opacity: 1; transform: translateY(0); } }
        
        .delay-1 { animation-delay: 100ms; }
        .delay-2 { animation-delay: 200ms; }
        .delay-3 { animation-delay: 300ms; }
        .delay-4 { animation-delay: 400ms; }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8">

    <div class="loader-bar"><div class="loader-progress" id="progressBar"></div></div>

    <header class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4 animate-in">
        <div>
            <h1 class="text-3xl font-bold text-white tracking-tight flex items-center gap-3">
                <span class="w-1 h-8 bg-indigo-500 rounded-full shadow-[0_0_15px_#6366f1]"></span>
                Operations <span class="text-indigo-400">Hub</span>
            </h1>
            <div class="flex items-center gap-2 mt-2 ml-4 text-xs text-slate-400">
                <span class="w-2 h-2 rounded-full bg-emerald-500 shadow-[0_0_10px_#10b981]" id="statusDot"></span>
                <span id="statusText">Connecting to Live Sheet...</span>
            </div>
        </div>
        <div class="glass-panel px-4 py-2 rounded-xl flex items-center gap-3">
    <div class="flex flex-col">
        <label class="text-[10px] text-slate-400 uppercase font-bold tracking-wider">From</label>
        <input type="date" id="startDate" onchange="filterData()" 
               class="bg-transparent text-white text-sm focus:outline-none font-mono cursor-pointer [&::-webkit-calendar-picker-indicator]:invert opacity-80 hover:opacity-100">
    </div>
    <div class="h-8 w-px bg-white/10"></div>
    <div class="flex flex-col">
        <label class="text-[10px] text-slate-400 uppercase font-bold tracking-wider">To</label>
        <input type="date" id="endDate" onchange="filterData()" 
               class="bg-transparent text-white text-sm focus:outline-none font-mono cursor-pointer [&::-webkit-calendar-picker-indicator]:invert opacity-80 hover:opacity-100">
    </div>
</div>
        <div class="relative group">
            <i class="fa-solid fa-filter absolute left-3 top-3 text-indigo-400 group-hover:text-indigo-300 transition-colors"></i>
            <select id="siteFilter" onchange="filterData()" class="glass-panel pl-10 pr-8 py-2.5 rounded-xl text-sm w-64 focus:outline-none text-white appearance-none cursor-pointer hover:bg-white/5 transition-colors">
                <option value="All">All Sites</option>
            </select>
            <i class="fa-solid fa-chevron-down absolute right-3 top-3.5 text-xs text-slate-500 pointer-events-none"></i>
        </div>
    </header>

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <div class="glass-panel rounded-2xl p-6 animate-in delay-1 relative overflow-hidden">
            <div class="absolute right-0 top-0 p-4 opacity-10"><i class="fa-solid fa-clipboard-list text-6xl text-indigo-500"></i></div>
            <p class="text-xs font-bold text-indigo-300 uppercase tracking-wider">Total Volume</p>
            <h3 class="text-3xl font-bold text-white mt-1" id="kpi-total">0</h3>
            <div class="mt-4 flex items-center text-xs text-slate-400 gap-2">
                <span class="bg-indigo-500/20 text-indigo-300 px-2 py-0.5 rounded">Interventions</span>
            </div>
        </div>

        <div class="glass-panel rounded-2xl p-6 animate-in delay-1 relative overflow-hidden">
             <div class="absolute right-0 top-0 p-4 opacity-10"><i class="fa-solid fa-map-location-dot text-6xl text-emerald-500"></i></div>
            <p class="text-xs font-bold text-emerald-300 uppercase tracking-wider">Site Coverage</p>
            <h3 class="text-3xl font-bold text-white mt-1" id="kpi-sites">0</h3>
            <div class="mt-4 flex items-center text-xs text-slate-400 gap-2">
                <span class="bg-emerald-500/20 text-emerald-300 px-2 py-0.5 rounded">Active Locations</span>
            </div>
        </div>

        <div class="glass-panel rounded-2xl p-6 animate-in delay-2 relative overflow-hidden">
             <div class="absolute right-0 top-0 p-4 opacity-10"><i class="fa-solid fa-triangle-exclamation text-6xl text-amber-500"></i></div>
            <p class="text-xs font-bold text-amber-300 uppercase tracking-wider">Top Motif</p>
            <h3 class="text-xl font-bold text-white mt-1 truncate pr-2" id="kpi-top-cat">...</h3>
            <div class="mt-4 flex items-center text-xs text-slate-400 gap-2">
                <span class="bg-amber-500/20 text-amber-300 px-2 py-0.5 rounded" id="kpi-cat-count">0</span>
                <span>occurrences</span>
            </div>
        </div>

        <div class="glass-panel rounded-2xl p-6 animate-in delay-2 relative overflow-hidden">
             <div class="absolute right-0 top-0 p-4 opacity-10"><i class="fa-solid fa-user-astronaut text-6xl text-rose-500"></i></div>
            <p class="text-xs font-bold text-rose-300 uppercase tracking-wider">Top Technician</p>
            <h3 class="text-xl font-bold text-white mt-1 truncate pr-2" id="kpi-top-tech">...</h3>
            <div class="mt-4 flex items-center text-xs text-slate-400 gap-2">
                <span class="bg-rose-500/20 text-rose-300 px-2 py-0.5 rounded">Most Active</span>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
        
        <div class="glass-panel rounded-2xl p-6 animate-in delay-2 flex flex-col items-center">
            <div class="w-full flex justify-between items-center mb-4">
                <h3 class="text-sm font-semibold text-white flex items-center gap-2">
                    <i class="fa-solid fa-bullseye text-pink-400"></i> Intervention Motifs
                </h3>
            </div>
            <div class="h-64 w-full relative">
                <canvas id="polarChart"></canvas>
            </div>
            <p class="text-xs text-slate-500 mt-4 text-center">Distribution of intervention reasons (Nature)</p>
        </div>

        <div class="glass-panel rounded-2xl p-6 animate-in delay-2 flex flex-col items-center">
            <div class="w-full flex justify-between items-center mb-4">
                <h3 class="text-sm font-semibold text-white flex items-center gap-2">
                    <i class="fa-solid fa-calendar-week text-cyan-400"></i> Weekly Rhythm
                </h3>
            </div>
            <div class="h-64 w-full relative">
                <canvas id="radarChart"></canvas>
            </div>
            <p class="text-xs text-slate-500 mt-4 text-center">Activity density by day of the week</p>
        </div>

        <div class="glass-panel rounded-2xl p-6 animate-in delay-2 flex flex-col h-full">
            <h3 class="text-sm font-semibold text-white mb-4 flex items-center gap-2">
                <i class="fa-solid fa-trophy text-yellow-400"></i> Tech Leaderboard
            </h3>
            <div class="flex-1 overflow-y-auto custom-scroll pr-2 space-y-3" id="tech-leaderboard">
                </div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
        
        <div class="glass-panel rounded-2xl p-6 lg:col-span-2 animate-in delay-3">
             <div class="flex justify-between items-center mb-6">
                <h3 class="text-sm font-semibold text-white flex items-center gap-2">
                    <i class="fa-solid fa-building-user text-indigo-400"></i> Attendance by Restaurant & Motif
                </h3>
                <span class="text-[10px] bg-slate-800 text-slate-400 px-2 py-1 rounded border border-slate-700">Top 12 Sites</span>
            </div>
            <div class="h-72 w-full">
                <canvas id="stackedBarChart"></canvas>
            </div>
        </div>

        <div class="glass-panel rounded-2xl p-6 animate-in delay-3">
            <h3 class="text-sm font-semibold text-white mb-6 flex items-center gap-2">
                <i class="fa-solid fa-chart-line text-emerald-400"></i> Activity Trend
            </h3>
            <div class="h-72 w-full">
                <canvas id="lineChart"></canvas>
            </div>
        </div>
    </div>

    <script>
        // === CONFIG ===
        const API_URL = "https://opensheet.elk.sh/1W_cpnAt98OHiOTHp9KmCwdWGbGYrGA6n15Eb-Vz0wD4/Interventions";
        let globalData = [];
        let charts = {};

        // === PALETTE ===
        const colors = {
            purple: '#8b5cf6',
            indigo: '#6366f1',
            blue: '#3b82f6',
            cyan: '#06b6d4',
            emerald: '#10b981',
            amber: '#f59e0b',
            rose: '#f43f5e',
            pink: '#ec4899',
            slate: '#64748b'
        };
        const palette = Object.values(colors);

        window.onload = loadData;

// === DATA LOADING ===
        async function loadData() {
            updateStatus('loading');
            try {
                const res = await fetch(API_URL);
                const json = await res.json();
                
                // DATA CLEANING & NORMALIZATION
                globalData = json.flatMap(row => {
                    // 1. GET RAW SITE
                    const rawSite = row['Restaurant'] || row['Site'] || 'Unknown';
                    
                    // 2. SPLIT MERGED SITES (e.g. "BK Settat, BK Abdelmoumen")
                    const sites = rawSite.split(',').map(s => s.trim());

                    // 3. CREATE A ROW FOR EACH SITE
                    return sites.map(siteName => ({
                        Date: row['Date'] || row['Start Date'],
                        Tech: row['Tech Name'] || row['Technicien'] || 'Unknown',
                        // 4. NORMALIZE THE NAME (Fix duplicates)
                        Site: normalizeSiteName(siteName), 
                        Motif: row['Nature'] || row['Type'] || 'Other'
                    }));
                }).filter(row => row.Tech && row.Tech !== 'Unknown');

                initFilters();
                renderDashboard(globalData);
                updateStatus('success');

            } catch (err) {
                console.error(err);
                updateStatus('error');
            }
        }

        // === HELPER: NAME NORMALIZER ===
        function normalizeSiteName(name) {
            if (!name) return 'Unknown';
            const lower = name.toLowerCase().trim();

            // 1. Handle "Head Office"
            if (lower.includes('head office') || lower.includes('retail holding')) return 'Head Office';

            // 2. Special Unique Cases
            if (lower.includes('2 m-ars')) return 'BK 2 Mars';
            if (lower.includes('all restaurants')) return 'All Restaurants';

            // 3. Standardize "BK [Location]"
            if (lower.includes('abdelmoumen')) return 'BK Abdelmoumen';
            if (lower.includes('agdal')) return 'BK Agdal Rabat';
            if (lower.includes('al mazar')) return 'BK Al Mazar';
            if (lower.includes('anfa place')) return 'BK Anfa Place';
            if (lower.includes('area mall')) return 'BK Area Mall';
            if (lower.includes('arribat')) return 'BK Arribat Center';
            if (lower.includes('bayda')) return 'BK El Bayda';
            if (lower.includes('bd anfa')) return 'BK Bd Anfa';
            if (lower.includes('beni mellal')) return 'BK Beni Mellal';
            if (lower.includes('borj fez')) return 'BK Borj Fez';
            if (lower.includes('bouregreg')) return 'BK Sale Bouregreg';
            if (lower.includes('carre eden')) return 'BK Carre Eden';
            if (lower.includes('carrefour sale')) return 'BK Carrefour Sale';
            if (lower.includes('dar bouazza')) return 'BK Dar Bouazza';
            if (lower.includes('el jadida')) return 'BK El Jadida';
            if (lower.includes('essalama')) return 'BK Essalama';
            if (lower.includes('exit casa')) return 'BK Exit Casa';
            if (lower.includes('harhoura')) return 'BK Harhoura';
            if (lower.includes('ibn battouta')) return 'BK Ibn Battouta';
            if (lower.includes('jazira')) return 'BK Al Jazira';
            if (lower.includes('kitea')) return 'BK Kitea Geant';
            if (lower.includes('laaraache')) return 'BK Laaraache';
            if (lower.includes('lafayette')) return 'BK Lafayette';
            if (lower.includes('maarif')) return 'BK Maarif';
            if (lower.includes('mahaj')) return 'BK Mahaj Riad';
            // Check specific Marina Sale first to avoid conflict with generic Marina
            if (lower.includes('marina sale')) return 'BK Marina Sale'; 
            else if (lower.includes('marina')) return 'BK Marina Casa';
            if (lower.includes('menara')) return 'BK Menara Mall';
            if (lower.includes('mohammadia')) return 'BK Mohammadia';
            if (lower.includes('morocco mall')) return 'BK Morocco Mall';
            if (lower.includes('ola')) return 'BK Ola Marrakech';
            if (lower.includes('settat')) return 'BK Settat';
            if (lower.includes('sidi maarouf')) return 'BK Sidi Maarouf';
            if (lower.includes('socco')) return 'BK Socco Alto';
            if (lower.includes('t-relais')) return 'BK T-Relais';
            if (lower.includes('tachfine')) return 'BK Tachfine Center';
            if (lower.includes('tanger')) return 'BK Tanger City Center';
            if (lower.includes('targa')) return 'BK Targa';
            if (lower.includes('temara')) return 'BK Temara';
            if (lower.includes('tetouan')) return 'BK Tetouan';
            if (lower.includes('zeir')) return 'BK Zeir';

            // 4. Default Formatting
            if (lower.startsWith('bk ')) {
                return 'BK ' + name.slice(3).charAt(0).toUpperCase() + name.slice(4);
            }
            return name.charAt(0).toUpperCase() + name.slice(1);
        }

        // === RENDER DASHBOARD ===
        function renderDashboard(data) {
            // 1. CALCULATE KPIs
            const total = data.length;
            const uniqueSites = new Set(data.map(d => d.Site)).size;
            
            const motifCounts = getCounts(data, 'Motif');
            const techCounts = getCounts(data, 'Tech');
            const topMotif = getTopKey(motifCounts);
            const topTech = getTopKey(techCounts);

            document.getElementById('kpi-total').innerText = total;
            document.getElementById('kpi-sites').innerText = uniqueSites;
            document.getElementById('kpi-top-cat').innerText = topMotif;
            document.getElementById('kpi-cat-count').innerText = motifCounts[topMotif];
            document.getElementById('kpi-top-tech').innerText = topTech;

            // 2. PREPARE CHART DATA
            
            // Polar Data (Motifs)
            const motifLabels = Object.keys(motifCounts);
            const motifValues = Object.values(motifCounts);

            // Radar Data (Days of Week)
            const daysOrder = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            const dayCounts = { 'Sun':0, 'Mon':0, 'Tue':0, 'Wed':0, 'Thu':0, 'Fri':0, 'Sat':0 };
            data.forEach(d => {
                const date = new Date(d.Date);
                if(!isNaN(date)) {
                    const dayName = daysOrder[date.getDay()];
                    dayCounts[dayName]++;
                }
            });
            const radarValues = daysOrder.map(d => dayCounts[d]);

            // Stacked Bar Data (Site vs Motif)
            // Get Top 12 Sites
            const siteCounts = getCounts(data, 'Site');
            const topSites = Object.entries(siteCounts).sort((a,b) => b[1] - a[1]).slice(0, 12).map(s => s[0]);
            
            // Get Top 4 Motifs (group rest as 'Other')
            const topMotifs = Object.entries(motifCounts).sort((a,b) => b[1] - a[1]).slice(0, 4).map(m => m[0]);
            
            // Build datasets for stacked bar
            const stackedDatasets = topMotifs.map((motif, index) => {
                return {
                    label: motif,
                    data: topSites.map(site => {
                        return data.filter(d => d.Site === site && d.Motif === motif).length;
                    }),
                    backgroundColor: palette[index % palette.length],
                    borderRadius: 2
                };
            });

            // Timeline Data
            const timeMap = {};
            data.forEach(d => {
                const k = d.Date.substring(0, 7); // YYYY-MM
                if(k.length > 4) timeMap[k] = (timeMap[k] || 0) + 1;
            });
            const timeKeys = Object.keys(timeMap).sort();
            const timeValues = timeKeys.map(k => timeMap[k]);


            // 3. RENDER CHARTS
            renderPolarChart(motifLabels, motifValues);
            renderRadarChart(daysOrder, radarValues);
            renderStackedBar(topSites, stackedDatasets);
            renderLineChart(timeKeys, timeValues);
            renderLeaderboard(techCounts, total);
        }

        // === CHART RENDERERS ===

        function renderPolarChart(labels, data) {
            const ctx = document.getElementById('polarChart').getContext('2d');
            if(charts.polar) charts.polar.destroy();

            charts.polar = new Chart(ctx, {
                type: 'polarArea',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: [
                            'rgba(99, 102, 241, 0.6)', // Indigo
                            'rgba(16, 185, 129, 0.6)', // Emerald
                            'rgba(245, 158, 11, 0.6)', // Amber
                            'rgba(244, 63, 94, 0.6)',  // Rose
                            'rgba(6, 182, 212, 0.6)'   // Cyan
                        ],
                        borderWidth: 1,
                        borderColor: 'rgba(255,255,255,0.1)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            grid: { color: 'rgba(255,255,255,0.1)' },
                            ticks: { display: false, backdropColor: 'transparent' },
                            angleLines: { color: 'rgba(255,255,255,0.1)' }
                        }
                    },
                    plugins: {
                        legend: { position: 'right', labels: { color: '#94a3b8', font: {size: 10}, boxWidth: 10 } }
                    }
                }
            });
        }

        function renderRadarChart(labels, data) {
            const ctx = document.getElementById('radarChart').getContext('2d');
            if(charts.radar) charts.radar.destroy();

            charts.radar = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Interventions',
                        data: data,
                        backgroundColor: 'rgba(236, 72, 153, 0.2)', // Pink fill
                        borderColor: '#ec4899',
                        pointBackgroundColor: '#fff',
                        pointBorderColor: '#ec4899'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            grid: { color: 'rgba(255,255,255,0.1)' },
                            ticks: { display: false, backdropColor: 'transparent' },
                            angleLines: { color: 'rgba(255,255,255,0.1)' },
                            pointLabels: { color: '#cbd5e1', font: {size: 11} }
                        }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }

        function renderStackedBar(labels, datasets) {
            const ctx = document.getElementById('stackedBarChart').getContext('2d');
            if(charts.bar) charts.bar.destroy();

            charts.bar = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { 
                            stacked: true, 
                            grid: { display: false },
                            ticks: { color: '#94a3b8', font: {size: 10}, maxRotation: 45, minRotation: 45 }
                        },
                        y: { 
                            stacked: true, 
                            grid: { color: 'rgba(255,255,255,0.05)' },
                            ticks: { color: '#94a3b8' } 
                        }
                    },
                    plugins: {
                        legend: { position: 'top', labels: { color: '#94a3b8', boxWidth: 10, font: {size: 10} } }
                    }
                }
            });
        }

        function renderLineChart(labels, data) {
            const ctx = document.getElementById('lineChart').getContext('2d');
            if(charts.line) charts.line.destroy();

            const gradient = ctx.createLinearGradient(0, 0, 0, 300);
            gradient.addColorStop(0, 'rgba(16, 185, 129, 0.4)');
            gradient.addColorStop(1, 'rgba(16, 185, 129, 0)');

            charts.line = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        borderColor: '#10b981', // Emerald
                        backgroundColor: gradient,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 3,
                        pointBackgroundColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { grid: { display: false }, ticks: { color: '#94a3b8' } },
                        y: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#94a3b8' } }
                    }
                }
            });
        }

        function renderLeaderboard(counts, total) {
            const container = document.getElementById('tech-leaderboard');
            container.innerHTML = '';
            const sorted = Object.entries(counts).sort((a,b) => b[1] - a[1]);

            sorted.forEach(([name, count], i) => {
                const pct = (count / total * 100).toFixed(0);
                // Assign rank colors
                let badgeColor = 'bg-slate-700 text-slate-300';
                if(i===0) badgeColor = 'bg-yellow-500/20 text-yellow-400 border border-yellow-500/30';
                if(i===1) badgeColor = 'bg-slate-400/20 text-slate-300 border border-slate-400/30';
                if(i===2) badgeColor = 'bg-orange-700/20 text-orange-400 border border-orange-700/30';

                container.innerHTML += `
                    <div class="flex items-center gap-3 p-3 rounded-xl bg-white/5 hover:bg-white/10 transition-colors border border-white/5">
                        <div class="h-8 w-8 rounded-full flex items-center justify-center font-bold text-xs ${badgeColor}">
                            ${i+1}
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex justify-between text-sm mb-1.5">
                                <span class="font-medium text-slate-200 truncate">${name}</span>
                                <span class="text-indigo-400 font-mono text-xs">${count}</span>
                            </div>
                            <div class="h-1.5 w-full bg-slate-800 rounded-full overflow-hidden">
                                <div class="h-full bg-indigo-500 rounded-full" style="width: ${pct}%"></div>
                            </div>
                        </div>
                    </div>
                `;
            });
        }

        // === UTILS ===
        function getCounts(data, key) {
            return data.reduce((acc, item) => {
                const val = item[key];
                acc[val] = (acc[val] || 0) + 1;
                return acc;
            }, {});
        }

        function getTopKey(obj) {
            if (Object.keys(obj).length === 0) return '-';
            return Object.keys(obj).reduce((a, b) => obj[a] > obj[b] ? a : b);
        }

        
        function initFilters() {
            const select = document.getElementById('siteFilter');
            const sites = [...new Set(globalData.map(d => d.Site))].sort();
            sites.forEach(s => {
                const opt = document.createElement('option');
                opt.value = s;
                opt.innerText = s;
                opt.className = "text-slate-900";
                select.appendChild(opt);
            });
        }

function filterData() {
    // 1. Get Values
    const siteVal = document.getElementById('siteFilter').value;
    const startVal = document.getElementById('startDate').value;
    const endVal = document.getElementById('endDate').value;

    // 2. Prepare Date Objects (set time to midnight for accurate comparison)
    const startDate = startVal ? new Date(startVal) : null;
    const endDate = endVal ? new Date(endVal) : null;
    if (startDate) startDate.setHours(0, 0, 0, 0);
    if (endDate) endDate.setHours(23, 59, 59, 999); // Include the whole end day

    // 3. Filter
    const filtered = globalData.filter(d => {
        // Site Check
        const siteMatch = siteVal === 'All' || d.Site === siteVal;

        // Date Check
        let dateMatch = true;
        if (d.Date) {
            const rowDate = new Date(d.Date);
            // Check validity of date
            if (!isNaN(rowDate)) {
                if (startDate && rowDate < startDate) dateMatch = false;
                if (endDate && rowDate > endDate) dateMatch = false;
            }
        }

        return siteMatch && dateMatch;
    });

    // 4. Render
    renderDashboard(filtered);
}

        function updateStatus(status) {
            const bar = document.getElementById('progressBar');
            const dot = document.getElementById('statusDot');
            const txt = document.getElementById('statusText');
            
            if(status === 'loading') {
                bar.style.width = '60%';
            } else if(status === 'success') {
                bar.style.width = '100%';
                setTimeout(() => bar.style.opacity = 0, 500);
                dot.className = "w-2 h-2 rounded-full bg-emerald-400 shadow-[0_0_10px_#10b981] animate-pulse";
                txt.innerText = "Live Data Connected";
                txt.className = "text-emerald-400 font-medium";
            } else {
                bar.style.background = '#ef4444';
                dot.className = "w-2 h-2 rounded-full bg-red-500";
                txt.innerText = "Connection Failed";
                txt.className = "text-red-400";
            }
        }
    </script>
</body>
</html>