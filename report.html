<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>📊 Intervention Reports</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <style>
    body { 
  background: #121212; 
  color: #f0f0f0; 
  font-family: "Segoe UI", sans-serif;
}

h2, h4 { 
  color: #ffcc00; 
  font-weight: bold; 
  letter-spacing: 1px; 
  text-shadow: 0 0 8px rgba(255, 204, 0, 0.5);
}

.table {
  background: #1e1e1e;
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 4px 15px rgba(0,0,0,0.6);
}

.table thead {
  background: linear-gradient(90deg, #ff7e00, #ffcc00);
  color: #121212;
}

.table tbody tr {
  transition: all 0.2s ease-in-out;
}
.table tbody tr:hover {
  background: rgba(255, 204, 0, 0.1);
  transform: scale(1.01);
}

.btn {
  border-radius: 10px;
  font-weight: bold;
  transition: all 0.3s ease-in-out;
}
.btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 0 12px rgba(255, 204, 0, 0.6);
}

    .container { margin-top: 30px; }
    .report-section { margin-top: 40px; }
    table th, table td { font-size: 14px; cursor: pointer; }
    th.sortable:hover { background: #343a40 !important; color: #ffc107; }
    th .arrow { font-size: 12px; margin-left: 5px; }
  </style>
</head>
<body>
  <div class="container">
    <h2 class="text-center mb-4">📋 Intervention Reports</h2>

    <!-- Search and Date Range -->
    <div class="row g-3 mb-3">
      <div class="col-md-3">
        <label class="form-label">Search by ID / Name</label>
        <input type="text" id="searchId" class="form-control" placeholder="Ex: BK002 or Hammou">
      </div>
      <div class="col-md-3">
        <label class="form-label">Start Date</label>
        <input type="date" id="startDate" class="form-control">
      </div>
      <div class="col-md-3">
        <label class="form-label">End Date</label>
        <input type="date" id="endDate" class="form-control">
      </div>
      <div class="col-md-3 d-flex align-items-end">
        <button class="btn btn-primary w-100" onclick="applyFilters()">🔎 Apply Filters</button>
      </div>
    </div>

    <!-- Interventions Table -->
    <div class="report-section">
      <h4>📊 Interventions</h4>
      <table class="table table-bordered table-striped" id="interventionTable">
        <thead class="table-dark">
          <tr>
            <th class="sortable" onclick="sortTable('Tech ID')">Tech ID <span class="arrow">↕</span></th>
            <th class="sortable" onclick="sortTable('Tech Name')">Tech Name <span class="arrow">↕</span></th>
            <th class="sortable" onclick="sortTable('Intervention ID')">Intervention ID <span class="arrow">↕</span></th>
            <th class="sortable" onclick="sortTable('Restaurant')">Restaurant <span class="arrow">↕</span></th>
            <th class="sortable" onclick="sortTable('Start Date')">Start Date <span class="arrow">↕</span></th>
            <th class="sortable" onclick="sortTable('End Date')">End Date <span class="arrow">↕</span></th>
            <th class="sortable" onclick="sortTable('Nature')">Nature <span class="arrow">↕</span></th>
            <th class="sortable" onclick="sortTable('Motif')">Motif <span class="arrow">↕</span></th>
            <th>Description</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <button class="btn btn-success mt-3" onclick="printInterventions()">🖨️ Print Interventions</button>
      <button class="btn btn-warning mt-3" onclick="generateMissionOrder()">📄 Générer Ordre de Mission</button>
<button class="btn btn-info mt-3" onclick="generateExpenseReport()">📄 Générer Note de Frais</button>
<div id="pagination" class="mt-3 d-flex justify-content-center"></div>

<script>
async function generateExpenseReport() {
  if (filteredData.length === 0) {
    alert("⚠️ Aucun enregistrement trouvé pour générer la Note de Frais.");
    return;
  }

  const sheetId = "1xUiaofSCIt6UgsIfqrLXN7FkcMaU-tLoKZmooBzEGFg";
  let expenses = await fetch(`https://opensheet.elk.sh/${sheetId}/Expenses`).then(r => r.json());

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF("landscape");
  let pageWidth = doc.internal.pageSize.getWidth();
  let pageHeight = doc.internal.pageSize.getHeight();
  let bottomMargin = 60; // espace réservé pour signatures

  const logoUrl = "https://upload.wikimedia.org/wikipedia/commons/thumb/4/4b/Burger_King_logo_%281999%E2%80%932020%29.svg/1200px-Burger_King_logo_%281999%E2%80%932020%29.svg.png";
  const logoImg = await loadImage(logoUrl);

  function drawHeader(first) {
    doc.addImage(logoImg, "PNG", 10, 10, 25, 25);

    doc.setFont("helvetica", "italic");
    doc.setFontSize(9);
    doc.text("Travel Expense", 40, 16);
    doc.setFont("helvetica", "bolditalic");
    doc.setFontSize(11);
    doc.text("Traveling Expenses Form", 40, 24);

    doc.setFont("helvetica", "bold");
    doc.setFontSize(12);
    doc.text("GENERAL FIRST FOOD SERVICES S.A.S", pageWidth / 2, 12, { align: "center" });

    doc.setFont("helvetica", "normal");
    doc.setFontSize(10);
    let xInfo = pageWidth - 80;
    doc.rect(xInfo, 15, 70, 25);
    doc.text(`N° Matricule : ${first["Tech ID"] || ""}`, xInfo + 3, 21);
    let techName = (first["Tech Name"] || "").split(" ");
    doc.text(`Nom : ${techName[0] || ""}`, xInfo + 3, 28);
    doc.text(`Prénom : ${techName.slice(1).join(" ") || ""}`, xInfo + 3, 35);

    let today = new Date().toLocaleDateString("fr-FR");
    doc.rect(xInfo, 45, 70, 10);
    doc.text(today, xInfo + 25, 52);
  }

  let grouped = {};
  let diversDetails = {};

  expenses.forEach(exp => {
    if (filteredData.some(f => f["Intervention ID"] === exp["Intervention ID"])) {
      let matchedIntervention = filteredData.find(f => f["Intervention ID"] === exp["Intervention ID"]);
      if (!matchedIntervention) return;

      let jour = new Date(matchedIntervention["Start Date"]).getDate();
      let mois = new Date(matchedIntervention["Start Date"]).getMonth() + 1;
      let libelle = matchedIntervention["Restaurant"] || "";

      let key = `${jour}-${mois}-${libelle}`;
      if (!grouped[key]) {
        grouped[key] = { jour, mois, libelle, train: 0, autoroute: 0, taxi: 0, kms: 0, montant: 0, hotel: 0, repas: 0, divers: 0 };
        diversDetails[key] = [];
      }

      let amount = parseFloat(exp["Montant"] || 0);
      let nature = (exp["Nature"] || "").trim().toLowerCase();

      if (nature.includes("taxi")) grouped[key].taxi += amount;
      else if (nature.includes("train")) grouped[key].train += amount;
      else if (nature.includes("meal") || nature.includes("repas")) grouped[key].repas += amount;
      else if (nature.includes("hotel") || nature.includes("hostel")) grouped[key].hotel += amount;
      else if (nature.includes("autoroute")) grouped[key].autoroute += amount;
      else if (nature.includes("kms")) {
        let kmsValue = parseFloat(exp["Montant"] || 0);
        grouped[key].kms += kmsValue;
        grouped[key].montant += kmsValue * 3;
      } else {
        grouped[key].divers += amount;
        diversDetails[key].push(`${exp["Description"] || "Autre"} | ${amount} dhs`);
      }
    }
  });

  let rows = Object.values(grouped).map(g => {
    let total = g.train + g.autoroute + g.taxi + g.montant + g.hotel + g.repas + g.divers;
    return [ g.jour, g.mois, g.libelle, g.train.toFixed(2), g.autoroute.toFixed(2), g.taxi.toFixed(2), g.kms.toFixed(0), g.montant.toFixed(2), g.hotel.toFixed(2), g.repas.toFixed(2), g.divers.toFixed(2), total.toFixed(2) ];
  });

  let totalGeneral = rows.reduce((acc, r) => acc + parseFloat(r[11]), 0);

  function drawTable(startY) {
    let colWidths = [15, 15, 45, 20, 25, 20, 15, 25, 25, 25, 25, 25];
    let headers = ["JOUR","MOIS","Libellé de la dépense","Train","Autoroute","Taxi","Kms","Montant","HOTEL","REPAS","DIVERS TTC","TOTAL"];

    let y = startY;
    let rowHeight = 8;

    function drawHeaderRow() {
      let x = 10;
      doc.setFont("helvetica", "bold");
      doc.setFontSize(9);
      headers.forEach((h, i) => {
        doc.rect(x, y, colWidths[i], 10);
        doc.text(h, x + colWidths[i]/2, y + 7, { align: "center" });
        x += colWidths[i];
      });
      y += 10;
    }

    drawHeaderRow();
    doc.setFont("helvetica", "normal");
    doc.setFontSize(9);

    rows.forEach((r, idx) => {
      if (y + rowHeight + bottomMargin > pageHeight) {
        doc.addPage();
        y = 20;
        drawHeaderRow();
      }
      let x = 10;
      r.forEach((cell, i) => {
        doc.rect(x, y, colWidths[i], rowHeight);
        doc.text(String(cell), x + colWidths[i]/2, y + 6, { align: "center" });
        x += colWidths[i];
      });
      y += rowHeight;

      let key = `${r[0]}-${r[1]}-${r[2]}`;
     
    });

    while (y + rowHeight + bottomMargin < pageHeight - 10) {
      let x = 10;
      headers.forEach((_, i) => {
        doc.rect(x, y, colWidths[i], rowHeight);
        x += colWidths[i];
      });
      y += rowHeight;
    }

    let x = 10;
    headers.forEach((_, i) => {
      doc.rect(x, y, colWidths[i], rowHeight);
      if (i === headers.length - 2) doc.text("TOTAL", x + colWidths[i]/2, y + 6, { align: "center" });
      if (i === headers.length - 1) doc.text(totalGeneral.toFixed(2), x + colWidths[i]/2, y + 6, { align: "center" });
      x += colWidths[i];
    });
    return y + rowHeight;
  }

  function drawBottomSection() {
    const pageWidth = doc.internal.pageSize.getWidth();
    const pageHeight = doc.internal.pageSize.getHeight();
    let y = pageHeight - 35;

    doc.rect(10, y, 90, 12);
    doc.text("N° Pièce :", 12, y + 7);

    doc.rect(10, y + 12, 90, 12);
    doc.text("Visa Comptabilité :", 12, y + 19);

    let labels = ["Signature Émetteur :","Visa Responsable :","Visa Finance Manager :","Visa General Manager :"];

    let xStart = 110;
    let availableWidth = pageWidth - xStart - 10;
    let boxWidth = availableWidth / labels.length;
    let boxHeight = 24;

    labels.forEach((l, idx) => {
      let x = xStart + idx * boxWidth;
      doc.rect(x, y, boxWidth, boxHeight);
      doc.text(l, x + 2, y + 7);
      doc.text("Date :", x + 2, y + 15);
    });
  }

  let first = filteredData[0];
  drawHeader(first);
  drawTable(65);
  drawBottomSection();

  let filename = `note_frais_${filteredData[0]["Tech ID"] || "tech"}.pdf`;
  doc.save(filename);

  function loadImage(url) {
    return new Promise((resolve) => {
      let img = new Image();
      img.crossOrigin = "Anonymous";
      img.onload = () => {
        let canvas = document.createElement("canvas");
        canvas.width = img.width; canvas.height = img.height;
        let ctx = canvas.getContext("2d");
        ctx.drawImage(img, 0, 0);
        resolve(canvas.toDataURL("image/png"));
      };
      img.src = url;
    });
  }
}
</script>



    </div>
  </div>

  <script>
    let allData = [];
    let filteredData = [];
    let sortDirections = {};

    // Load data from Intervention sheet
    fetch("https://opensheet.elk.sh/1xUiaofSCIt6UgsIfqrLXN7FkcMaU-tLoKZmooBzEGFg/Interventions")
      .then(res => res.json())
      .then(data => {
        console.log("✅ Data loaded:", data); // Debug check
        allData = data;
        filteredData = data;
        renderTable(data);
      })
      .catch(err => console.error("❌ Error loading data:", err));

    // Render interventions table
function formatDateOnly(dateStr) {
  if (!dateStr) return "";
  let d = new Date(dateStr);
  if (isNaN(d)) return dateStr;
  return d.toLocaleDateString("fr-FR"); // dd/mm/yyyy only
}

let currentPage = 1;
let rowsPerPage = 25;

function renderTable(data) {
  let tbody = document.querySelector("#interventionTable tbody");
  tbody.innerHTML = "";

  let startIndex = (currentPage - 1) * rowsPerPage;
  let endIndex = startIndex + rowsPerPage;
  let pageData = data.slice(startIndex, endIndex);

  pageData.forEach(row => {
    tbody.innerHTML += `
      <tr>
        <td>${row["Tech ID"] || ""}</td>
        <td>${row["Tech Name"] || ""}</td>
        <td>${row["Intervention ID"] || ""}</td>
        <td>${row["Restaurant"] || ""}</td>
        <td>${formatDateOnly(row["Start Date"])}</td>
        <td>${formatDateOnly(row["End Date"])}</td>
        <td>${row["Nature"] || ""}</td>
        <td>${row["Motif"] || ""}</td>
        <td>${row["Description"] || ""}</td>
      </tr>
    `;
  });

  renderPagination(data.length);
}

function renderPagination(totalRows) {
  let totalPages = Math.ceil(totalRows / rowsPerPage);
  let pagination = document.getElementById("pagination");
  pagination.innerHTML = "";

  let prevBtn = `<button class="btn btn-outline-light mx-1" onclick="changePage(-1)" ${currentPage===1?"disabled":""}>⬅ Prev</button>`;
  let nextBtn = `<button class="btn btn-outline-light mx-1" onclick="changePage(1)" ${currentPage===totalPages?"disabled":""}>Next ➡</button>`;
  
  pagination.innerHTML = prevBtn + `<span class="mx-2 align-self-center">Page ${currentPage} / ${totalPages}</span>` + nextBtn;
}

function changePage(direction) {
  currentPage += direction;
  renderTable(filteredData);
}



function applyFilters() {
  let searchId = document.getElementById("searchId").value.toLowerCase();
  let startDate = new Date(document.getElementById("startDate").value);
  let endDate = new Date(document.getElementById("endDate").value);

  filteredData = allData.filter(row => {
    // Search in all relevant fields
    let matchSearch = searchId
      ? (
          (row["Tech ID"] || "").toLowerCase().includes(searchId) ||
          (row["Tech Name"] || "").toLowerCase().includes(searchId) ||
          (row["Intervention ID"] || "").toLowerCase().includes(searchId) ||
          (row["Restaurant"] || "").toLowerCase().includes(searchId) ||
          (row["Description"] || "").toLowerCase().includes(searchId) ||
          (row["Motif"] || "").toLowerCase().includes(searchId)
        )
      : true;

    // Date filter based on Start Date
    let d = new Date(row["Start Date"]);
    let matchDate = (!isNaN(startDate) && !isNaN(endDate)) ? (d >= startDate && d <= endDate) : true;

    return matchSearch && matchDate;
  });

  renderTable(filteredData);
}


    // Sort by column
    function sortTable(column) {
      if (!sortDirections[column]) sortDirections[column] = "asc";
      else sortDirections[column] = sortDirections[column] === "asc" ? "desc" : "asc";

      filteredData.sort((a, b) => {
        let valA = a[column] || "";
        let valB = b[column] || "";
        // Parse dates for correct sorting
        if (column.includes("Date")) {
          valA = new Date(valA);
          valB = new Date(valB);
        }
        if (valA < valB) return sortDirections[column] === "asc" ? -1 : 1;
        if (valA > valB) return sortDirections[column] === "asc" ? 1 : -1;
        return 0;
      });

      renderTable(filteredData);
    }

    // Print interventions table as PDF
    function printInterventions() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF("landscape");

      // Header
      doc.setFontSize(16);
      doc.text("Intervention Report", 14, 15);

      // Prepare table
      const tableColumn = ["Tech ID","Tech Name","Intervention ID","Restaurant","Start Date","End Date","Nature","Motif","Description"];
      const tableRows = [];

      filteredData.forEach(row => {
        tableRows.push([
          row["Tech ID"] || "",
          row["Tech Name"] || "",
          row["Intervention ID"] || "",
          row["Restaurant"] || "",
          row["Start Date"] || "",
          row["End Date"] || "",
          row["Nature"] || "",
          row["Motif"] || "",
          row["Description"] || ""
        ]);
      });

      doc.autoTable({
        head: [tableColumn],
        body: tableRows,
        startY: 25,
        styles: { fontSize: 9 },
        headStyles: { fillColor: [0, 0, 0] }
      });

      // ===== PDF File Naming =====
      let filename = "int_report_all.pdf";
      let searchId = document.getElementById("searchId").value.trim();
      let startDate = document.getElementById("startDate").value;

      if (searchId) {
        filename = `int_report_${searchId}.pdf`;
      } else if (startDate) {
        let d = new Date(startDate);
        let mm = String(d.getMonth() + 1).padStart(2, "0");
        let yy = String(d.getFullYear()).slice(-2);
        filename = `int_report${mm}${yy}.pdf`;
      }

      doc.save(filename);
    }
  </script>


<script>
async function generateMissionOrder() {
  if (filteredData.length === 0) {
    alert("⚠️ Aucun enregistrement trouvé pour générer l'Ordre de Mission.");
    return;
  }

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF("portrait");

  let pageWidth = doc.internal.pageSize.getWidth();
  let pageHeight = doc.internal.pageSize.getHeight();

  let maxLinesPerPage = 8; // nombre de missions max par page 
  let missionChunks = chunkArray(filteredData, maxLinesPerPage);

  for (let pageIndex = 0; pageIndex < missionChunks.length; pageIndex++) {
    if (pageIndex > 0) doc.addPage();

    // ====== CADRE GLOBAL (lié au contenu) ======
    doc.rect(10, 10, pageWidth - 20, pageHeight - 20);

    // ====== HEADER ======
    const logoUrl =
      "https://upload.wikimedia.org/wikipedia/commons/thumb/4/4b/Burger_King_logo_%281999%E2%80%932020%29.svg/1200px-Burger_King_logo_%281999%E2%80%932020%29.svg.png";
    const logoImg = await loadImage(logoUrl);
    doc.addImage(logoImg, "PNG", 12, 12, 20, 20);

    doc.setFont("helvetica", "bold");
    doc.setFontSize(14);
    doc.text("ORDRE DE MISSION", pageWidth / 2, 22, { align: "center" });

    doc.setFont("helvetica", "normal");
    doc.setFontSize(9);
    doc.text("GENERAL FIRST FOOD SERVICES", pageWidth - 70, 15);
    doc.text("RH-V02-2016", pageWidth - 70, 20);
    let today = new Date().toLocaleDateString("fr-FR");
    doc.text(`Date : ${today}`, pageWidth - 70, 25);

    // ====== SECTION : Infos employé ======
    doc.setFontSize(10);
    doc.setFont("helvetica", "bold");
    doc.text("INFORMATIONS SUR L'EMPLOYE", 14, 40);
    doc.rect(12, 32, pageWidth - 24, 35);

    let first = filteredData[0];
    let techName = (first["Tech Name"] || "").split(" ");

    doc.setFont("helvetica", "normal");
    doc.text(`Matricule : ${first["Tech ID"] || ""}`, 14, 48);
    doc.text(`NOM : ${techName[0] || ""}`, 14, 55);
    doc.text(`PRENOM : ${techName.slice(1).join(" ") || ""}`, 80, 55);
    doc.text("DEPARTEMENT : IT", 14, 62);
    doc.text("FONCTION : IT", 80, 62);

    // ====== SECTION : Objet de mission ======
    doc.setFont("helvetica", "bold");
    doc.text("Objet de mission :", 14, 78);

    let startY = 85;
    let currentMissions = missionChunks[pageIndex];

    doc.setFont("helvetica", "normal");

    currentMissions.forEach((row) => {
      let start = formatDateOnly(row["Start Date"]);
      let end = formatDateOnly(row["End Date"]);
      let motifText = row["Motif"] || "Installation – Réparation";
      let description = row["Description"] ? ` (${row["Description"]})` : "";
      let textFull = `${row["Restaurant"] || ""} - ${motifText}${description}`;

      doc.text(`Date Départ : ${start}`, 14, startY);
      doc.text(`Date Retour : ${end}`, 70, startY);

      let wrappedMotif = doc.splitTextToSize(textFull, 60);
      doc.text(wrappedMotif, 130, startY);

      startY += Math.max(10, wrappedMotif.length * 5);
    });

    // Compléter avec lignes vides (si pas assez de missions)
    while (currentMissions.length < maxLinesPerPage) {
      doc.text("Date Départ : ___________", 14, startY);
      doc.text("Date Retour : ___________", 70, startY);
      doc.text("__________________________", 130, startY);
      startY += 10;
      currentMissions.push({});
    }

    // ====== Frais déplacement ======
    startY += 5;
    doc.setFont("helvetica", "bold");
    doc.text("Frais Déplacement :", 14, startY);
    doc.rect(12, startY - 8, pageWidth - 24, 15);

    doc.setFont("helvetica", "normal");
    doc.rect(65, startY - 4, 4, 4);
    doc.text("Oui", 72, startY);
    doc.rect(90, startY - 4, 4, 4);
    doc.text("Non", 97, startY);
    doc.text("Montant d'avance : ____________", 140, startY);

    // ====== Moyen transport ======
    startY += 20;
    doc.setFont("helvetica", "bold");
    doc.text("Moyen de transport utilisé :", 14, startY);
    doc.rect(12, startY - 8, pageWidth - 24, 20);

    doc.setFont("helvetica", "normal");
    doc.rect(80, startY - 4, 4, 4);
    doc.text("Véhicule Personnel", 87, startY);
    doc.rect(140, startY - 4, 4, 4);
    doc.text("Véhicule Professionnel", 147, startY);
    startY += 8;
    doc.rect(80, startY - 4, 4, 4);
    doc.text("Autre :", 87, startY);

    // ====== Signatures ======
    let sigY = pageHeight - 60;
    doc.rect(12, sigY - 10, pageWidth - 24, 40);
    doc.setFont("helvetica", "bold");
    doc.text("INTERESSE(E)", 30, sigY);
    doc.text("DEPARTEMENT MANAGER", pageWidth / 2 - 20, sigY);
    doc.text("GENERAL MANAGER", pageWidth - 70, sigY);

    // ====== Footer ======
    doc.setFontSize(8);
    doc.setFont("helvetica", "normal");
    doc.text(
      "*Avant la mission, validation obligatoire par le supérieur hiérarchique et le DG.",
      14,
      pageHeight - 15
    );
  }

  // SAVE
  let filename = `ordre_mission_${filteredData[0]["Tech ID"] || "tech"}.pdf`;
  doc.save(filename);

  // ==== Helper load image ====
  function loadImage(url) {
    return new Promise((resolve) => {
      let img = new Image();
      img.crossOrigin = "Anonymous";
      img.onload = () => {
        let canvas = document.createElement("canvas");
        canvas.width = img.width;
        canvas.height = img.height;
        let ctx = canvas.getContext("2d");
        ctx.drawImage(img, 0, 0);
        resolve(canvas.toDataURL("image/png"));
      };
      img.src = url;
    });
  }

  // ==== Helper split missions ====
  function chunkArray(arr, size) {
    let result = [];
    for (let i = 0; i < arr.length; i += size) {
      result.push(arr.slice(i, i + size));
    }
    return result;
  }
}

function formatDateOnly(dateStr) {
  if (!dateStr) return "";
  let d = new Date(dateStr);
  if (isNaN(d)) return dateStr;
  return d.toLocaleDateString("fr-FR");
}
</script>



</body>
</html>
